package com.comverse.upm.common;

/**
 * 
 * @author osmolya
 */

import static org.junit.Assert.assertEquals;

import com.comverse.upm.upmPages.ProcessPage;
import com.thoughtworks.selenium.Selenium;

public class UpmValidation {

    private Selenium callerSelenium;
    //    private String DefaultTimeout = "100000";
    private String DefaultWorkflowType = "CBS Batch Process";

    public UpmValidation(Selenium selenium) {
        this.callerSelenium = selenium;
    }

    public void validateLastWorkflowCompleted(int stateCheckIterations) throws Exception {
  //      UpmWait waiting = new UpmWait(callerSelenium);
        UpmNavigation Navigate = new UpmNavigation(callerSelenium);
        ProcessPage processPage = new ProcessPage(callerSelenium);
        //Click on History tab
        Navigate.goToProcessWorkflowHistory();

        processPage.selectHistoryWorkflowType(DefaultWorkflowType);

        //Wait for workflow to complete
        waitForLastWorkflowToComplete(stateCheckIterations);

        //Check that job is complete
        assertEquals("COMPLETE", callerSelenium.getTable("_id83:_id84:0:_id398:wkpTabID:0:_id616:jobHistoryTable.1.4"));
    }

    public void waitForLastWorkflowToComplete(int stateCheckIterations) throws Exception {

        ProcessPage processPage = new ProcessPage(callerSelenium);
        UpmUtils Utils = new UpmUtils(callerSelenium);
        UpmWait waiting = new UpmWait(callerSelenium);
        //Click on Refresh button
        processPage.clickHistoryRefresh();

        //Check job is created in ACTIVE state	
        //Comment this out if going to COMPLETE right away
       // waiting.forCondition("selenium.getTable(\"_id83:_id84:0:_id398:wkpTabID:0:_id616:jobHistoryTable.1.4\")== 'ACTIVE'");	

        //While job is not complete, click on refresh button and re-check 
        String workflowState = Utils.getWorkflowState();

        int counter = 0;
        Boolean workflowStateComparison = (workflowState.equals("ACTIVE"));
        do {
            //Click on refresh button
            processPage.clickHistoryRefresh();
            workflowState = Utils.getWorkflowState();
            System.out.println(workflowState);
            workflowStateComparison = (workflowState.equals("ACTIVE"));
            System.out.println(workflowStateComparison);
            counter++;
        } while ((workflowState.equals("ACTIVE")) && (counter < stateCheckIterations));

    }

}
