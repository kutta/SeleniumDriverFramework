/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package com.comverse.upm.financials;

/**
 *
 * @author Administrator
 */


import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.ResultSet;

/*import org.junit.After;
import org.junit.Before;
import java.io.*;
import java.io.BufferedWriter;
import java.io.IOException;
*/

import net.neoremind.sshxcute.core.ConnBean;
import net.neoremind.sshxcute.core.SSHExec;
import net.neoremind.sshxcute.task.CustomTask;
// import net.neoremind.sshxcute.task.impl.ExecCommand;
import net.neoremind.sshxcute.task.impl.ExecShellScript;
import net.neoremind.sshxcute.core.Result;
import net.neoremind.sshxcute.exception.TaskExecFailException;
//import com.thoughtworks.selenium.DefaultSelenium;
//import com.thoughtworks.selenium.SeleneseTestCase;


public class Reference_for_unix_callout {

public static String insert_sched(String accno)
    {
    System.out.println("executing main going to call function ");
  Connection conn = null;
        String url = "jdbc:oracle:thin:@//10.45.71.152:1521/";
        String dbctlg = "ctlg";
        String driver = "oracle.jdbc.OracleDriver";
        String userName = "cbs_owner";
        String password = "comverse";
        String Schema = null;
        //String accno = "66";
        String servid = null;
        try {
            Class.forName(driver);
            conn = DriverManager.getConnection(url + dbctlg, userName, password);
            System.out.println("Connected to the database ctlg");
            try {
                Statement st = conn.createStatement();
                String sql = "select a.account_no,a.server_id,b.ds_database,b.hostname from account_lookup a,server_definition b where a.server_id = b.server_id and a.account_no='"+accno+"'";
                ResultSet rset=st.executeQuery(sql);
                System.out.println("Query executed");
                try {
                        while (rset.next())
                        {
                        Schema=(rset.getString(3));// Print col 1
                        servid=(rset.getString(2));// print col 2
                        accno=(rset.getString(1));// print col 3
                        }
                    }
               finally {
                         try { rset.close(); } catch (Exception ignore) {}
                        }

                    } catch (SQLException s) {
                     System.err.println("SQL statement is not executed!");
                     s.printStackTrace();
            }

            conn.close();
            System.out.println("Disconnected from database ctlg");

        }

         catch (Exception e) {
            e.printStackTrace();
        }

       try {
            Class.forName(driver);
            conn = DriverManager.getConnection(url + Schema, userName, password);
            System.out.println("Connected to the database "+Schema);
            try {
                Statement st = conn.createStatement();
                System.out.println("schema: "+Schema);
                System.out.println("account_no: "+accno);
                System.out.println("server_id: "+servid);
                String sql = "delete from process_sched where process_name like 'bip39%'";
                String inst ="insert into process_sched (process_name, task_name, task_cycle, task_mode, sched_start, task_intrvl, task_status, task_priority, slide_time, db_name, sql_query,debug_level) values ('bip39', 'bip39', 'N',0, SYSDATE, 86400, 0, 0, 30,'"+Schema+"', 'cmf.account_no in ("+accno+")',0)";
                st.executeQuery(sql);
                st.executeUpdate(inst);
                    } catch (SQLException s) {
                     System.err.println("SQL statement is not executed!");
                     s.printStackTrace();
            }

            conn.close();
            System.out.println("Disconnected from database"+Schema);

        }

        catch (Exception e) {
            e.printStackTrace();
        }

        return servid;

    }

    public static void unj(String serv_id)
    {
        SSHExec ssh = null;
        try{
           ConnBean cb = new ConnBean("10.45.71.152", "cbsuser","cbsuser");
           ssh = SSHExec.getInstance(cb);
           CustomTask ct3 = new ExecShellScript("/home/cbsuser","./bip_execute.sh "+serv_id,"");
           ssh.connect();
           Result res = ssh.exec(ct3);
           if (res.isSuccess)
    {
        System.out.println("Return code: " + res.rc);
        System.out.println("sysout: " + res.sysout);
    }
    else
    {
        System.out.println("Return code: " + res.rc);
        System.out.println("error message: " + res.error_msg);
    }

        }
        catch (TaskExecFailException e)
{
    System.out.println(e.getMessage());
    e.printStackTrace();
}
catch (Exception e)
{
    System.out.println(e.getMessage());
    e.printStackTrace();
}
finally
{
    ssh.disconnect();
}

    }

public static void main (String args[])
{
String Serv_id;
String accno="64";
System.out.println("going to do process_sched insert");
Serv_id=insert_sched( accno );
System.out.println("done process_sched insert");
System.out.println("going to do BIP execution");
unj(Serv_id);
System.out.println("Done BIP");
}

}


